# This pipeline is triggered whenever a PR is completed to any of the following branches:

# By default, each solution is build.

# The pipeline deploys a solution if for that solution files have changed in their respective 
# folders. 

trigger:
  branches:
    include:
    - main
    - qas
    - prod

parameters:
- name: azure_data_factory
  displayName: Azure Data Factory
  type: boolean
  default: True
- name: orchestration
  displayName: Orchestration DB
  type: boolean
  default: True
- name: synapse_dwh
  displayName: Synapse DWH
  type: boolean
  default: True
- name: synapse_workspace
  displayName: Synapse Workspace
  type: boolean
  default: True
- name: xu_config
  displayName: Xtract Universal
  type: boolean
  default: True

variables:
# In case of CI triggered pipelines (IndividualCI, triggered by git push),
# use the system predefined variable Build.SourceBranchName to get the correct variable template
- ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
  - template: ./variables-test.yml
- ${{ elseif eq(variables['Build.SourceBranchName'], 'qas') }}:
  - template: ./variables-qas.yml
- ${{ elseif eq(variables['Build.SourceBranchName'], 'prod') }}:
  - template: ./variables-prod.yml
- ${{ elseif or(contains(variables['Build.SourceBranch'], '/feature/'), contains(variables['Build.SourceBranch'], '/users/')) }}:
  - template: ./variables-personal.yml
  - name: user
    value: ${{ split(variables['Build.SourceBranch'], '/')[3] }} #refs/heads/feature/mpors/...

stages:        
- template: ./stages-build.yml
  parameters:
    build_azure_data_factory: ${{ parameters.azure_data_factory }}
    build_orchestration: ${{ parameters.orchestration }}
    build_synapse_dwh: ${{ parameters.synapse_dwh }}
    build_synapse_workspace: ${{ parameters.synapse_workspace }}
    build_xu_config: ${{ parameters.xu_config }}