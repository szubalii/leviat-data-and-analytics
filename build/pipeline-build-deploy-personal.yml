trigger: none

parameters:
- name: runDeployment
  displayName: Run Deployments
  type: boolean
  default: False
- name: azure_data_factory
  displayName: Azure Data Factory
  type: boolean
  default: True
- name: orchestration
  displayName: Orchestration DB
  type: boolean
  default: True
- name: synapse_dwh
  displayName: Synapse DWH
  type: boolean
  default: True
- name: synapse_workspace
  displayName: Synapse Workspace
  type: boolean
  default: True
- name: xu_config
  displayName: Xtract Universal
  type: boolean
  default: True

variables:
- ${{ if or(contains(variables['Build.SourceBranch'], '/feature/'), contains(variables['Build.SourceBranch'], '/users/')) }}:
  - name: user
    value: ${{ split(variables['Build.SourceBranch'], '/')[3] }} #refs/heads/feature/mpors/...
  - template: ./variables-personal.yml
  - name: deployEnvPrefix # override value to map main branch to DEV deployment environment
    value: ${{ format('30_DEV_{0}', upper(variables.user)) }}

- stages:
  - template: ./stages-build-deploy-2.yml
    parameters:
      build_azure_data_factory: ${{ parameters.azure_data_factory }}
      build_orchestration: ${{ parameters.orchestration }}
      build_synapse_dwh: ${{ parameters.synapse_dwh }}
      build_synapse_workspace: ${{ parameters.synapse_workspace }}
      build_xu_config: ${{ parameters.xu_config }}
      deploy_azure_data_factory: ${{ parameters.runDeployment }}
      deploy_orchestration: ${{ parameters.runDeployment }}
      deploy_synapse_dwh: ${{ parameters.runDeployment }}
      deploy_synapse_workspace: ${{ parameters.runDeployment }}
      deploy_xu_config: ${{ parameters.runDeployment }}