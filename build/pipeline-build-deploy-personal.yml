trigger: none

parameters:
- name: azure_data_factory
  displayName: Azure Data Factory
  type: boolean
  default: True
- name: orchestration
  displayName: Orchestration DB
  type: boolean
  default: True
- name: synapse_dwh
  displayName: Synapse DWH
  type: boolean
  default: True
- name: synapse_workspace
  displayName: Synapse Workspace
  type: boolean
  default: True
- name: xu_config
  displayName: Xtract Universal
  type: boolean
  default: True
- name: runDeployment
  displayName: Run Deployments
  type: boolean
  default: False



variables:
- ${{ if or(contains(variables['Build.SourceBranch'], '/feature/'), contains(variables['Build.SourceBranch'], '/users/')) }}:
  - template: ./variables-personal.yml
  - name: user
    value: ${{ split(variables['Build.SourceBranch'], '/')[3] }} #refs/heads/feature/mpors/...
  - name: deployEnvPrefix # override value to map main branch to DEV deployment environment
    value: ${{ format('30_DEV_{0}', upper(variables.user)) }}

extends:
- template: ./pipeline-build-deploy.yml
  # only run this template when the source branch is not a release branch (main, qas, prod)
  condition: ${{ notIn(variables['Build.SourceBranchName'], 'main', 'qas', 'prod') }}
  parameters:
    build_azure_data_factory: ${{ parameters.azure_data_factory }}
    build_orchestration: ${{ parameters.orchestration }}
    build_synapse_dwh: ${{ parameters.synapse_dwh }}
    build_synapse_workspace: ${{ parameters.synapse_workspace }}
    build_xu_config: ${{ parameters.xu_config }}
    deploy_azure_data_factory: ${{ parameters.runDeployment }}
    deploy_orchestration: ${{ parameters.runDeployment }}
    deploy_synapse_dwh: ${{ parameters.runDeployment }}
    deploy_synapse_workspace: ${{ parameters.runDeployment }}
    deploy_xu_config: ${{ parameters.runDeployment }}











# variables:
# - ${{ if or(contains(variables['Build.SourceBranch'], '/feature/'), contains(variables['Build.SourceBranch'], '/users/')) }}:
#   - name: user
#     value: ${{ split(variables['Build.SourceBranch'], '/')[3] }} #refs/heads/feature/mpors/...
#   - template: ./variables-personal.yml
#   - name: deployEnvPrefix # override value to map main branch to DEV deployment environment
#     value: ${{ format('30_DEV_{0}', upper(variables.user)) }}
# - name: synDWHSolution
#   value: '**/synapse-dwh/*.sln'
# - name: orchDBSolution
#   value: '**/orchestration/*.sln'
# - name: buildPlatform
#   value: 'Any CPU'
# - name: buildConfiguration
#   value: 'Release'
# # store the latest source commit ID, used for running specific tests
# # - ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
# #   - name: commitId
# #     value: $(System.PullRequest.SourceCommitId)
# # - ${{ else }}:
# - name: commitId
#   value: $(Build.SourceVersion)
# - name: ConnectionString
#   value: $(SynapseTesterConnectionString)

# stages:
# - template: ./stages-build-deploy-2.yml
#   parameters:
#     build_azure_data_factory: ${{ parameters.azure_data_factory }}
#     build_orchestration: ${{ parameters.orchestration }}
#     build_synapse_dwh: ${{ parameters.synapse_dwh }}
#     build_synapse_workspace: ${{ parameters.synapse_workspace }}
#     build_xu_config: ${{ parameters.xu_config }}
#     deploy_azure_data_factory: ${{ parameters.runDeployment }}
#     deploy_orchestration: ${{ parameters.runDeployment }}
#     deploy_synapse_dwh: ${{ parameters.runDeployment }}
#     deploy_synapse_workspace: ${{ parameters.runDeployment }}
#     deploy_xu_config: ${{ parameters.runDeployment }}
#   # only run this template when the source branch is not a release branch (main, qas, prod)
#   condition: ${{ notIn(variables['Build.SourceBranchName'], 'main', 'qas', 'prod') }}
