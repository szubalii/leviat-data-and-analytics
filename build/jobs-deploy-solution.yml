parameters:
- name: folder
  type: string
- name: test
  type: boolean
  default: false

# variables:
# - name: deployEnvSolution
#   value: $(envIndex)_$(deployEnv)_${{ upper(replace(parameters.folder, '-', '_')) }}

jobs:
- job: Vars
  pool:
    name: 'VM'
    demands:
    - node.js
    - VisualStudio
    - Agent.ComputerName -equals $(VMName)
  steps:
  - script: |
      echo deployEnv: $(deployEnv)
      echo envIndex: $(envIndex)
- deployment: DEPLOY_${{ format('{0}_{1}_{2}', variables.envIndex, variables.deployEnv, upper(replace(parameters.folder, '-', '_'))) }}
  timeoutInMinutes: 120
  pool:
    name: 'VM'
    demands:
    - node.js
    - VisualStudio
    - Python.Version
    - Agent.ComputerName -equals $(VMName)
  environment: ${{ format('{0}_{1}_{2}', variables.envIndex, variables.deployEnv, upper(replace(parameters.folder, '-', '_'))) }}
  workspace:
    clean: $(clean)
  strategy:
    runOnce:
      deploy:
        steps:
        - template: ../${{ parameters.folder }}/build/steps-deploy.yml

        - ${{ if parameters.test }}:
          - template: ../${{ parameters.folder }}/build/steps-test.yml