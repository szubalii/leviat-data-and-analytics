parameters:
- name: build_azure_data_factory
  displayName: Azure Data Factory
  type: boolean
  default: True
- name: build_orchestration
  displayName: Orchestration DB
  type: boolean
  default: True
- name: build_synapse_dwh
  displayName: Synapse DWH
  type: boolean
  default: True
- name: build_synapse_workspace
  displayName: Synapse Workspace
  type: boolean
  default: True
- name: build_xu_config
  displayName: Xtract Universal
  type: boolean
  default: True
- name: deploy_azure_data_factory
  displayName: Azure Data Factory
  type: boolean
  default: False 
  # How to make dependend parameter based on True value of build_azure_data_factory
- name: deploy_orchestration
  displayName: Orchestration DB
  type: boolean
  default: False
- name: deploy_synapse_dwh
  displayName: Synapse DWH
  type: boolean
  default: False
- name: deploy_synapse_workspace
  displayName: Synapse Workspace
  type: boolean
  default: False
- name: deploy_xu_config
  displayName: Xtract Universal
  type: boolean
  default: False


# variables:
# - name: build_azure_data_factory
#   value: ${{ parameters.build_azure_data_factory }}
# - name: build_orchestration
#   value: ${{ parameters.build_orchestration }}
# - name: build_synapse_dwh
#   value: ${{ parameters.build_synapse_dwh }}
# - name: build_synapse_workspace
#   value: ${{ parameters.build_synapse_workspace }}
# - name: build_xu_config
#   value: ${{ parameters.build_xu_config }}
# - name: deploy_azure_data_factory
#   value: ${{ parameters.deploy_azure_data_factory }}
# - name: deploy_orchestration
#   value: ${{ parameters.deploy_orchestration }}
# - name: deploy_synapse_dwh
#   value: ${{ parameters.deploy_synapse_dwh }}
# - name: deploy_synapse_workspace
#   value: ${{ parameters.deploy_synapse_workspace }}
# - name: deploy_xu_config
#   value: ${{ parameters.deploy_xu_config }}
# - name: commitId
#   value: $(Build.SourceVersion)
# - name: synDWHSolution
#   value: '**/synapse-dwh/*.sln'
# - name: orchDBSolution
#   value: '**/orchestration/*.sln'
# - name: buildPlatform
#   value: 'Any CPU'
# - name: buildConfiguration
#   value: 'Release'
# - name: ConnectionString
#   value: $(SynapseTesterConnectionString)
# variables:
# - name: synDWHSolution
#   value: '**/synapse-dwh/*.sln'
# - name: orchDBSolution
#   value: '**/orchestration/*.sln'
# - name: buildPlatform
#   value: 'Any CPU'
# - name: buildConfiguration
#   value: 'Release'
# - name: ConnectionString
#   value: $(SynapseTesterConnectionString)

# Set these default values in case of manually triggered pipelines
# These values will be overriden for production environment
# - name: VMName
#   value: WEALEVAPP001
# - name: VMResourceGroup
#   value: rg-xxxx-sls-a-euw-001

# variable 'deployEnvPrefix' needs to be defined without 
# reference to variables in template as templates variables
# cannot be used as source for name of environment and deployment
# in deployment job


# - ${{ elseif startsWith(variables['Build.SourceBranchName'], 'dev_') }}:
#   - name: user
#     value: $[ replace( variables['Build.SourceBranchName'], 'dev_', '') ]
#   - template: ./variables-personal.yml
# - ${{ elseif contains(variables['Build.SourceBranch'], '/dev/') }}:
#   - name: user
#     value: $[ variables['Build.SourceBranchName'] ]
#   - template: ./variables-personal.yml
#   - name: deployEnv # override value to map main branch to DEV deployment environment
#     value: ${{ format('DEV_{0}', upper(variables['Build.SourceBranchName'])) }}



# - ${{ else }}:
#   - name: deployEnv
#     value: ${{ format('{0}_{1}', variables.environmentIndex, variables.environment) }}


# # Required for PR triggered pipelines as predefined system variable Build.SourceBranchName
# # equals value: 'merge'. Also, the predefined system variable System.PullRequest.TargetBranch 
# # is not available in templates. So use separate build pipelines for each env and pass this as parameter value
# # https://learn.microsoft.com/en-us/azure/devops/pipelines/build/variables?view=azure-devops&tabs=yaml#system-variables-devops-services


# store the latest source commit ID, used for running specific tests
# - ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
#   - name: commitId
#     value: $(System.PullRequest.SourceCommitId)
# - ${{ else }}:
#   - name: commitId
#     value: $(Build.SourceVersion)


stages:
- stage: DEPLOYMENT
  # only run this template when the source branch is not a release branch (main, qas, prod)
  # and was triggered by git push
  condition: ${{ and(in(variables['Build.SourceBranchName'], 'main', 'qas', 'prod'), eq(variables['Build.Reason'], 'IndividualCI')) }}
  variables:
  - name: commitId
    value: $(Build.SourceVersion)
  - name: deploy_azure_data_factory
    value: ${{ parameters.deploy_azure_data_factory }}
  - name: deploy_orchestration
    value: ${{ parameters.deploy_orchestration }}
  - name: deploy_synapse_dwh
    value: ${{ parameters.deploy_synapse_dwh }}
  - name: deploy_synapse_workspace
    value: ${{ parameters.deploy_synapse_workspace }}
  - name: deploy_xu_config
    value: ${{ parameters.deploy_xu_config }}
  - name: ConnectionString
    value: $(SynapseTesterConnectionString)
  jobs:
  - job: SOLUTIONS
    pool:
      vmImage: 'ubuntu-20.04'
    steps:
    - checkout: self
      fetchDepth: 0 # disables shallow fetch and results in correct return of git diff-tree
    
    - task: PowerShell@2
      displayName: 'Define which solutions deploy'
      name: solutionDeployment
      inputs:
        targetType: 'inline'
        pwsh: true
        script: |

          # Retrieve list of changed files
          Write-Host "System.DefaultWorkingDirectory: $(System.DefaultWorkingDirectory)"
          Write-Host "CommitID: $(commitId)"
          # Write-Host "Build.SourceVersion: $(Build.SourceVersion)"
          Write-Host "Build.SourceVersionMessage: $(Build.SourceVersionMessage)"
          $filePaths = $(git diff --name-only $(commitId)^!) #difference between parent of commit and commit
          # $filePaths2 = $(git diff-tree --no-commit-id --name-only -r $(Build.SourceVersion))
          Write-Host "Changed files using commitId: $($filePaths)"

          $solutionFolders = @('azure-data-factory/', 'orchestration/', 'synapse-dwh/', 'synapse-workspace/', 'xu-config/')

          ForEach ($solutionFolder in $solutionFolders) {
            if (($filePaths -match $solutionFolder).count -eq 0){
              $solutionVarName = 'deploy_' + $solutionFolder.TrimEnd('/')
              Write-Host "##vso[task.setvariable variable=$solutionVarName;isoutput=true]false"
            }
          }
  - template: ./jobs-deploy-multi.yml
    parameters:
      solutions:
      - name: 'orchestration'
        deploy: $[ dependencies.SOLUTIONS.outputs['solutionDeployment.deploy_orchestration'] ]
      - name: 'synapse-dwh'
        deploy: $[ dependencies.SOLUTIONS.outputs['solutionDeployment.deploy_synapse_dwh'] ]
        test: True
      - name: 'synapse-workspace'
        deploy: $[ dependencies.SOLUTIONS.outputs['solutionDeployment.deploy_synapse_workspace'] ]
      - name: 'xu-config'
        deploy: $[ dependencies.SOLUTIONS.outputs['solutionDeployment.deploy_xu_config'] ]
      deployEnvPrefix: ${{ variables.deployEnvPrefix }}
- stage: DEPLOY_ADF
  dependsOn: DEPLOYMENT
  condition: $[ stageDependencies.DEPLOYMENT.SOLUTIONS.outputs['solutionDeployment.deploy_azure_data_factory'] ]
  jobs:
  - template: ./jobs-deploy-multi.yml
    parameters:
      solutions:
      - name: 'azure-data-factory'
        deploy: True
      deployEnvPrefix: ${{ variables.deployEnvPrefix }}

- stage: VARIABLES
  jobs:
  - job: Vars
    pool:
      name: 'VM'
      demands:
      - node.js
      - VisualStudio
      - Agent.ComputerName -equals $(VMName)
    steps:
    # When this pipeline is run manually, only deployment to personal
    # environments is allowed, so no TEST, QAS, PROD
    # Include validation that branch names follow convention:
    #   main/qas/prod
    #   feature/<user>/<topic>
    #   users/<user>/<topic>
    #   hotfix/*** 
    # output variables
    - script: |
        echo system.pullRequest.targetBranch: $(system.pullRequest.targetBranch)
        echo user: $(user)
        echo dataFactoryName: $(dataFactoryName)
        echo sqlDatabaseName: $(sqlDatabaseName)
        echo synapseSqlPool: $(synapseSqlPool)
        echo storageAccountName: $(storageAccountName)
        echo xuPrefix: $(xuPrefix)
        echo destination: $(destination)
        echo Build.Reason: ${{ variables['Build.Reason'] }}
        echo Build.SourceBranch: ${{ variables['Build.SourceBranch'] }}
        echo Build.SourceBranchName: ${{ variables['Build.SourceBranchName'] }}
        echo deployEnvPrefix: ${{ variables.deployEnvPrefix }}
        echo parameters.build_synapse_dwh: ${{ parameters.build_synapse_dwh }}
        echo parameters.build_azure_data_factory: ${{ parameters.build_azure_data_factory }}
        echo parameters.build_orchestration: ${{ parameters.build_orchestration }}
        echo parameters.build_xu_config: ${{ parameters.build_xu_config }}
        echo parameters.build_synapse_workspace: ${{ parameters.build_synapse_workspace }}
        echo parameters.deploy_synapse_dwh: ${{ parameters.deploy_synapse_dwh }}
        echo parameters.deploy_azure_data_factory: ${{ parameters.deploy_azure_data_factory }}
        echo parameters.deploy_orchestration: ${{ parameters.deploy_orchestration }}
        echo parameters.deploy_xu_config: ${{ parameters.deploy_xu_config }}
        echo parameters.deploy_synapse_workspace: ${{ parameters.deploy_synapse_workspace }}
      displayName: Print Variables
- stage: VALIDATE
  jobs:
  - template: ./jobs-validate.yml
- stage: BUILD
  variables:
  - name: buildPlatform
    value: 'Any CPU'
  - name: buildConfiguration
    value: 'Release'
  - name: synDWHSolution
    value: '**/synapse-dwh/*.sln'
  - name: orchDBSolution
    value: '**/orchestration/*.sln'
  jobs:
  - template: ./jobs-build-solution.yml
    parameters:
      solutions:
      - name: 'synapse-dwh'
        build: ${{ parameters.build_synapse_dwh }}
      - name: 'azure-data-factory'
        build: ${{ parameters.build_azure_data_factory }}
      - name: 'orchestration'
        build: ${{ parameters.build_orchestration }}
      - name: 'xu-config'
        build: ${{ parameters.build_xu_config }}
      - name: 'synapse-workspace'
        build: ${{ parameters.build_synapse_workspace }}


- ${{ if or(variables.deploy_synapse_dwh, variables.deploy_orchestration, variables.deploy_xu_config, variables.deploy_synapse_workspace) }}:
  - stage: DEPLOY_1
    jobs:
    - template: ./jobs-deploy-multi.yml
      parameters:
        solutions:
        - name: 'synapse-dwh'
          deploy: ${{ variables.deploy_synapse_dwh }}
          test: True
        - name: 'orchestration'
          deploy: ${{ variables.deploy_orchestration }}
        - name: 'xu-config'
          deploy: ${{ variables.deploy_xu_config }}
        - name: 'synapse-workspace'
          deploy: ${{ variables.deploy_synapse_workspace }}
        deployEnvPrefix: ${{ variables.deployEnvPrefix }}
    
    # - ${{ if variables.buildAndDeploy_xu_config }}:
    #   - template: ./jobs-deploy-solution-helper.yml
    #     parameters:
    #       folder: xu-config
    #       deployEnvPrefix: ${{ variables.deployEnvPrefix }}
    # - ${{ if variables.buildAndDeploy_synapse_dwh }}:
    #   - template: ./jobs-deploy-solution-helper.yml
    #     parameters:
    #       folder: synapse-dwh
    #       deployEnvPrefix: ${{ variables.deployEnvPrefix }}
    #       test: true
    # - ${{ if variables.buildAndDeploy_orchestration }}:
    #   - template: ./jobs-deploy-solution-helper.yml
    #     parameters:
    #       folder: orchestration
    #       deployEnvPrefix: ${{ variables.deployEnvPrefix }}
    # - ${{ if variables.buildAndDeploy_synapse_workspace }}:
    #   - template: ./jobs-deploy-solution-helper.yml
    #     parameters:
    #       folder: synapse-workspace
    #       deployEnvPrefix: ${{ variables.deployEnvPrefix }}

  
  - ${{ if variables.deploy_azure_data_factory }}:
    - stage: DEPLOY_2
      jobs:
      - template: ./jobs-deploy-solution-helper.yml
        parameters:
          folder: azure-data-factory
          deployEnvPrefix: ${{ variables.deployEnvPrefix }}