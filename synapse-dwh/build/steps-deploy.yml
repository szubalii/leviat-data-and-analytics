steps:
- task: AzurePowerShell@5
  displayName: 'Resume Synapse'
  inputs:
    azureSubscription: 'arm-pipeline'
    ScriptType: InlineScript
    Inline: |
     # You can write your azure powershell scripts inline here. 
     # You can also pass predefined and custom variables to this script using arguments
     
     Resume-AzSynapseSqlPool -WorkspaceName "$(workspaceName)" -Name "$(synapseSqlPool)"
    azurePowerShellVersion: LatestVersion
    pwsh: true

# - task: AzureFileCopy@5
#   displayName: 'AzureBlob File Copy'
#   inputs:
#     SourcePath: '$(Pipeline.Workspace)/SynapseDWH/Master Data/*'
#     azureSubscription: 'arm-pipeline'
#     Destination: AzureBlob
#     storage: '$(storageAccountName)'
#     ContainerName: 'flat-files'
# Directly reference azcopy instead of AzureFileCopy@4 to resolve copy issues
- task: PowerShell@2
  displayName: 'Copy Master Data to AzureBlob'
  inputs:
    targetType: 'inline'
    pwsh: true
    script: |
      # connect to Azure using VM
      azcopy login --identity

      # directly copy to storage account using azcopy
      # workaround to exclude ProductCalculated as fix (blob)
      azcopy copy '$(Pipeline.Workspace)\SynapseDWH\Master Data\*' 'https://$(storageAccountName).blob.core.windows.net/flat-files' --recursive --exclude-pattern=ProductCalculated.csv
      
      # workaround to include ProductCalculated as fix (dfs)
      azcopy copy '$(Pipeline.Workspace)\SynapseDWH\Master Data\*' 'https://$(storageAccountName).dfs.core.windows.net/flat-files' --recursive --include-pattern=ProductCalculated.csv

- task: SqlAzureDacpacDeployment@1
  displayName: 'Azure SQL DacpacTask'
  inputs:
    azureSubscription: 'arm-pipeline'
    AuthenticationType: servicePrincipal
    ServerName: '$(workspaceName).sql.azuresynapse.net'
    DatabaseName: '$(synapseSqlPool)'
    DacpacFile: '$(Pipeline.Workspace)/SynapseDWH/syndw_xxxx_sls_d_euw_001.dacpac'
    AdditionalArguments: '/v:masterKeyPwd=$(ws-xxxx-sls-x-euw-001-masterKeyPwd) /v:storageAccount=$(storageAccountName)'