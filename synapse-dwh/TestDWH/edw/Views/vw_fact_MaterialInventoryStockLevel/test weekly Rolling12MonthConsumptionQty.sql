-- CREATE PROCEDURE [tc.edw.vw_fact_MaterialInventoryStockLevel].[test weekly Rolling12MonthConsumptionQty]
-- AS
-- BEGIN

--   IF OBJECT_ID('actual') IS NOT NULL DROP TABLE actual;
--   IF OBJECT_ID('expected') IS NOT NULL DROP TABLE expected;

--   -- Assemble: Fake Table
--   EXEC tSQLt.FakeTable '[edw]', '[dim_Calendar]';
--   EXEC tSQLt.FakeTable '[edw]', '[fact_MaterialDocumentItem]';

--   INSERT INTO edw.dim_Calendar (
--     CalendarDate,
--     YearWeek,
--     YearMonth,
--     FirstDayOfMonthDate
--   )
--   VALUES
--     ('2022-12-22', 202251, 202212, '2022-12-01'),
--     ('2023-01-01', 202252, 202301, '2023-01-01'),
--     ('2023-01-02', 202301, 202301, '2023-01-01'),
--     ('2023-01-09', 202302, 202301, '2023-01-01'),
--     ('2023-01-16', 202303, 202301, '2023-01-01'),
--     ('2023-01-23', 202304, 202301, '2023-01-01'),
--     ('2023-01-29', 202304, 202301, '2023-01-01'),
--     ('2023-02-01', 202305, 202302, '2023-02-01'),
--     ('2023-02-06', 202306, 202302, '2023-02-01'),
--     ('2023-02-13', 202307, 202302, '2023-02-01'),
--     ('2023-02-20', 202308, 202302, '2023-02-01'),
--     ('2023-02-27', 202309, 202302, '2023-02-01'),
--     ('2023-03-06', 202310, 202303, '2023-03-01'),
--     ('2023-03-13', 202311, 202303, '2023-03-01'),
--     ('2023-03-20', 202312, 202303, '2023-03-01'),
--     ('2023-03-27', 202313, 202303, '2023-03-01'),
--     ('2023-04-03', 202314, 202304, '2023-04-01'),
--     ('2023-04-10', 202315, 202304, '2023-04-01'),
--     ('2023-04-17', 202316, 202304, '2023-04-01'),
--     ('2023-04-24', 202317, 202304, '2023-04-01'),
--     ('2023-05-01', 202318, 202305, '2023-05-01'),
--     ('2023-05-08', 202319, 202305, '2023-05-01'),
--     ('2023-05-15', 202320, 202305, '2023-05-01'),
--     ('2023-05-22', 202321, 202305, '2023-05-01'),
--     ('2023-05-29', 202322, 202305, '2023-05-01'),
--     ('2023-06-05', 202323, 202306, '2023-06-01'),
--     ('2023-06-12', 202324, 202306, '2023-06-01'),
--     ('2023-06-19', 202325, 202306, '2023-06-01'),
--     ('2023-06-26', 202326, 202306, '2023-06-01'),
--     ('2023-07-08', 202327, 202307, '2023-07-01'),
--     ('2023-07-10', 202328, 202307, '2023-07-01'),
--     ('2023-07-17', 202329, 202307, '2023-07-01'),
--     ('2023-07-24', 202330, 202307, '2023-07-01'),
--     ('2023-07-31', 202331, 202307, '2023-07-01'),
--     ('2023-08-07', 202332, 202308, '2023-08-01'),
--     ('2023-08-14', 202333, 202308, '2023-08-01'),
--     ('2023-08-21', 202334, 202308, '2023-08-01'),
--     ('2023-08-28', 202335, 202308, '2023-08-01'),
--     ('2023-09-04', 202336, 202309, '2023-09-01'),
--     ('2023-09-11', 202337, 202309, '2023-09-01'),
--     ('2023-09-18', 202338, 202309, '2023-09-01'),
--     ('2023-09-25', 202339, 202309, '2023-09-01'),
--     ('2023-10-02', 202340, 202310, '2023-10-01'),
--     ('2023-10-09', 202341, 202310, '2023-10-01'),
--     ('2023-10-22', 202342, 202310, '2023-10-01'),
--     ('2023-10-23', 202343, 202310, '2023-10-01'),
--     ('2023-10-30', 202344, 202310, '2023-10-01'),
--     ('2023-11-06', 202345, 202311, '2023-11-01'),
--     ('2023-11-13', 202346, 202311, '2023-11-01'),
--     ('2023-11-20', 202347, 202311, '2023-11-01'),
--     ('2023-11-27', 202348, 202311, '2023-11-01'),
--     ('2023-12-04', 202349, 202312, '2023-12-01'),
--     ('2023-12-11', 202350, 202312, '2023-12-01'),
--     ('2023-12-18', 202351, 202312, '2023-12-01'),
--     ('2023-12-25', 202352, 202312, '2023-12-01'),
--     ('2024-01-01', 202401, 202401, '2024-01-01'),
--     ('2024-01-08', 202402, 202401, '2024-01-01'),
--     ('2024-01-15', 202403, 202401, '2024-01-01'),
--     ('2024-01-22', 202404, 202401, '2024-01-01'),
--     ('2024-01-23', 202404, 202401, '2024-01-01'),
--     ('2024-01-29', 202405, 202401, '2024-01-01'),
--     ('2024-02-11', 202406, 202402, '2024-02-01'),
--     ('2024-02-18', 202407, 202402, '2024-02-01'),
--     ('2024-02-25', 202408, 202402, '2024-02-01'),
--     ('2024-02-29', 202408, 202402, '2024-02-01'),
--     ('2024-03-01', 202409, 202403, '2024-03-01');

--   INSERT INTO edw.fact_MaterialDocumentItem (
--     [MaterialID]
--   , [HDR_PostingDate]
--   , [MatlCnsmpnQtyInMatlBaseUnit]
--   , [t_applicationId]
--   )
--   VALUES
--     (1, '2022-12-22', 100, 's4h-cap-100'),
--     (1, '2023-01-29', -20, 's4h-cap-100'),
--     (1, '2023-02-01', -20, 's4h-cap-100'),
--     (1, '2023-07-08',  10, 's4h-cap-100'),
--     (1, '2023-10-22',  20, 's4h-cap-100'),
--     (1, '2024-01-22', -10, 's4h-cap-100'),
--     (1, '2024-01-23', -10, 's4h-cap-100'),
--     (1, '2024-02-29',  20, 's4h-cap-100'),
--     (1, '2024-03-01',  20, 's4h-cap-100');

--   -- Act: 
--   SELECT
--     [MaterialID],
--     [YearWeek],
--     -- [YearMonth],
--     [Rolling12MonthConsumptionQty]
--   INTO actual
--   FROM [edw].[vw_fact_MaterialInventoryStockLevel]
--   WHERE
--     YearWeek <= 202409

--   -- Assert:
--   SELECT TOP(0) *
--   INTO expected
--   FROM actual;
  
--   INSERT INTO expected (
--     [MaterialID],
--     [YearWeek],
--     -- [YearMonth],
--     [Rolling12MonthConsumptionQty]
--   )
--   VALUES
--     (1, 202251, 100),
--     (1, 202252, 100),
--     (1, 202301, 100),
--     (1, 202302, 100),
--     (1, 202303, 100),
--     (1, 202304,  80),
--     (1, 202305,  60),
--     (1, 202306,  60),
--     (1, 202307,  60),
--     (1, 202308,  60),
--     (1, 202309,  60),
--     (1, 202310,  60),
--     (1, 202311,  60),
--     (1, 202312,  60),
--     (1, 202313,  60),
--     (1, 202314,  60),
--     (1, 202315,  60),
--     (1, 202316,  60),
--     (1, 202317,  60),
--     (1, 202318,  60),
--     (1, 202319,  60),
--     (1, 202320,  60),
--     (1, 202321,  60),
--     (1, 202322,  60),
--     (1, 202323,  60),
--     (1, 202324,  60),
--     (1, 202325,  60),
--     (1, 202326,  60),
--     (1, 202327,  70),
--     (1, 202328,  70),
--     (1, 202329,  70),
--     (1, 202330,  70),
--     (1, 202331,  70),
--     (1, 202332,  70),
--     (1, 202333,  70),
--     (1, 202334,  70),
--     (1, 202335,  70),
--     (1, 202336,  70),
--     (1, 202337,  70),
--     (1, 202338,  70),
--     (1, 202339,  70),
--     (1, 202340,  70),
--     (1, 202341,  70),
--     (1, 202342,  90),
--     (1, 202343,  90),
--     (1, 202344,  90),
--     (1, 202345,  90),
--     (1, 202346,  90),
--     (1, 202347,  90),
--     (1, 202348,  90),
--     (1, 202349,  90),
--     (1, 202350,  90),
--     (1, 202351, -10),
--     (1, 202352, -10),
--     (1, 202401, -10),
--     (1, 202402, -10),
--     (1, 202403, -10),
--     (1, 202404, -10),
--     (1, 202405,  10),
--     (1, 202406,  10),
--     (1, 202407,  10),
--     (1, 202408,  30),
--     (1, 202409,  50);

--   EXEC tSQLt.AssertEqualsTable 'expected', 'actual';
-- END;
